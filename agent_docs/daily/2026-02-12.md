# 2026년 2월 12일: 프론트엔드-백엔드 데이터 모델 동기화 및 버그 수정

**핵심 목표:** 프론트엔드에서 발생한 에러를 해결하는 과정에서, 백엔드와 프론트엔드 전체에 걸쳐 사용되는 데이터 ID를 기존 `genius_id`에서 MusicBrainz ID인 `mbid`로 완전히 전환하고, 이 과정에서 발견된 주요 버그들을 수정하여 시스템 안정성을 확보했습니다.

-   **신규 API 엔드포인트 개발:**
    -   기존 `genius_id` 기반의 협업 관계 조회 API를 대체하기 위해, `mbid`를 기반으로 동작하는 새로운 API 엔드포인트(`GET /artists/mbid/{mbid}/collaboration-details`)를 백엔드에 추가했습니다.
    -   이를 위해 `crud.py`에 `get_collaboration_details_by_mbid` 함수를 새로 구현했습니다.

-   **데이터 수집 전략 변경 및 구현:**
    -   사용자의 요청에 따라, 데이터 수집 기준을 '릴리즈(앨범)' 단위에서 '레코딩(곡)' 단위로 변경했습니다.
    -   `musicbrainz_api.py`에 `get_artist_recordings` 함수를 추가하고, `services.py`의 `import_artist_by_mbid` 로직을 페이지네이션을 통해 아티스트의 모든 곡을 수집하도록 전면 수정했습니다.
    -   넓은 범위의 관계를 효율적으로 수집하기 위해, 아티스트당 수집하는 곡의 수를 50곡으로 제한하는 로직을 추가했습니다.
    -   `backend/app/services.py`에서 YouTube URL 수집을 위해 `youtube_api.search_youtube_video(query)` 호출 주석을 해제했습니다.

-   **프론트엔드 ID 시스템 현대화:**
    -   백엔드 변경에 맞춰 프론트엔드의 모든 ID 처리 로직을 `mbid` 기반으로 수정했습니다.
    -   `utils/layout.js`: 노드 ID를 `mbid`로 생성하도록 변경.
    -   `App.jsx`: 노드 클릭 시 `mbid`를 파싱하고 `focus` 상태를 관리하도록 변경.
    -   `hooks/useGraphData.jsx`: 새로 추가된 `mbid` 기반 API를 호출하도록 변경.

-   **주요 버그 수정 (404 Not Found 해결):**
    -   2차 노드 클릭 시 발생하던 `404 Not Found` 에러의 근본 원인을 로그 분석을 통해 찾아냈습니다.
    -   원인은 `App.jsx`에서 하이픈(`-`)이 포함된 `mbid`(UUID)를 `split('-')`으로 잘못 파싱하여 `mbid`의 첫 부분만 API로 넘기고 있었기 때문입니다.
    -   ID의 첫 부분(`type`)을 제외한 나머지 부분을 다시 하이픈으로 합쳐 완전한 `mbid`를 복원하도록 파싱 로직을 수정하여 버그를 해결했습니다.

-   **데이터베이스 잠금 오류 개선:**
    -   `sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) database is locked` 오류 해결을 위해 `backend/app/database.py`에 `timeout=30`을 추가했습니다.
    -   `crud.py`에서 `db.flush()` 호출을 제거하여 트랜잭션 관리를 서비스 계층으로 집중시켰습니다.
    -   `services.py`의 `import_artist_by_mbid` 함수에서 `db.commit()`을 아티스트별 탐색이 완료된 후 한 번만 호출하도록 변경하여 데이터베이스 쓰기 충돌을 최소화했습니다.
    -   새로 생성된 `db_person`의 ID를 `update_person_explored_status`에서 사용하기 위해, `services.py`의 `crud.create_person` 호출 직후 `db.flush()` 및 `db.refresh()`를 명시적으로 추가했습니다.

-   **데이터베이스 초기화 및 탐색 재개:**
    -   변경된 데이터 수집 전략을 적용하기 위해 기존 데이터베이스와 로그를 모두 삭제하고, 새로운 설정으로 데이터 탐색을 다시 시작했습니다.

-   **UI 개선 및 '별자리' 컨셉 도입:**
    -   **스타일 리팩토링**: 다크모드 배경, 별 모양 노드, 별자리 선 모양 엣지 등 '별자리' 테마를 전체 UI에 적용했습니다.
    -   **자연스러운 노드 배치**: 노드, 특히 2차 노드들이 인공적인 원형이 아닌 자연스럽게 흩뿌려지도록 레이아웃 로직을 개선했습니다.
    -   **UI 플레이스홀더 추가**: 향후 구현을 위해 검색창의 UI 틀을 미리 구현했습니다.
    -   **Hover 정보창 내용 구현 완료**: `NodeInfoWindow.jsx` 및 `NodeInfoWindow.css`에 `image_url`과 `youtube_url`을 표시하는 로직과 스타일을 구현 완료했습니다.
    -   **'별자리 발자취' 기능 (시도 및 롤백)**: 새로운 노드를 탐색할 때 이전 노드가 누적되는 기능을 구현했으나, 여러 버그와 상태 관리의 복잡성으로 인해 **안정적인 이전 상태로 롤백**했습니다. 이 기능은 더 견고한 계획과 함께 향후 재시도할 예정입니다.

---

### 향후 작업 목록 (Future Tasks)

-   **'별자리 발자취' 기능 재구현**: 상세 계획을 바탕으로, 상태 관리 로직을 보강하여 안정적인 '발자취' 기능을 다시 구현합니다.
-   **검색 기능 구현**: 현재 UI만 구현된 검색창에 실제 아티스트/노래를 검색하는 기능을 추가해야 합니다.
-   **'노래' 중심 탐색 기능**: 현재 '아티스트' 중심 탐색만 `mbid` 기반으로 리팩토링 되었습니다. '노래' 노드 클릭 시의 탐색 로직도 `mbid` 기반으로 변경이 필요합니다.

---
### '별자리 발자취' 상세 구현 계획 (2차 시도)

1.  **데이터 흐름 및 상태 관리 리팩토링 (핵심)**
    *   **`useGraphData` 훅 분리**: `useGraphData` 훅을 더 이상 UI 상태를 직접 관리하지 않고, 순수하게 백엔드로부터 **데이터만 가져와서 반환**하는 역할로 변경합니다. 레이아웃 계산은 이 단계에서 하지 않습니다.
    *   **`App.jsx`의 역할 강화**: `App.jsx` 컴포넌트가 `useNodesState`, `useEdgesState`를 사용하여 **모든 노드와 엣지의 상태를 직접 관리**하도록 합니다. 즉, `App.jsx`가 모든 별과 별자리의 유일한 '주인'이 됩니다.
    *   **탐색 히스토리 관리**: `App.jsx`에 `focusHistory`라는 상태를 만들어, 사용자가 탐색한 중심 노드들의 `mbid`를 순서대로 저장합니다.

2.  **'발자취'를 위한 그래프 병합 및 재배치 로직 구현**
    *   **데이터 병합**: `App.jsx`에 `useEffect`를 사용하여, `useGraphData`가 새로운 데이터를 가져올 때마다 기존 그래프에 **새로운 노드와 엣지를 누적(병합)**하는 로직을 구현합니다. (중복 데이터는 제외)
    *   **'발자취' 스타일 적용**: 병합 과정에서 `focusHistory`에 기록된 이전 중심 노드들을 찾아, `opacity`를 낮추는 등 '지나간 발자취'임을 나타내는 스타일을 적용합니다.
    *   **상대적 재배치**: 새로 추가되는 별자리(노드 그룹)가 항상 `(0,0)` 좌표를 기준으로 그려지는 것을 방지합니다. 대신, **새로운 중심이 된 노드의 현재 화면상 위치를 기준**으로, 그 주변에 새로운 별자리가 그려지도록 좌표를 동적으로 재계산합니다.

3.  **UI/UX 최종 조정**
    *   새로운 노드들이 추가될 때 `fitView` 옵션을 조정하여 화면이 너무 급격하게 변하지 않고, 자연스럽게 확장되는 느낌을 주도록 합니다.
---

### 2026-02-12 (오후) - DB 록킹 및 데이터 지속성 문제 디버깅

-   **YouTube API 인증 리팩토링:**
    -   사용자의 제안에 따라, `youtube_api.py`와 `services.py`를 수정하여 YouTube 서비스 객체(`youtube_service`)를 한 번만 생성하고 재사용하도록 변경했습니다(싱글턴 패턴).
    -   이 수정으로 인해, 데이터 탐색 과정에서 반복적으로 Google 인증 팝업이 뜨는 문제를 해결했습니다. 이제 인증은 백엔드 서버 시작 시 단 한 번만 필요합니다.

-   **`database is locked` 오류 재발 및 해결:**
    -   YouTube API 연동 후, 다시 `database is locked` 오류가 발생했습니다.
    -   `services.py`의 `import_artist_by_mbid` 함수 내에서, 새로 생성된 인물의 ID를 즉시 얻기 위해 사용했던 `db.flush()`와 `db.refresh()` 호출이 데이터베이스 록의 원인임을 확인했습니다.
    -   해당 라인을 제거하여 `database is locked` 오류를 해결했고, 로그상으로 탐색 프로세스가 정상적으로 더 오래 실행되는 것을 확인했습니다.

-   **데이터 지속성 문제 발견 (최종 이슈):**
    -   `database is locked` 오류 해결 후, 탐색이 로그상으로는 정상적으로 진행되나 실제 `kpop.db` 파일의 `persons`와 `songs` 테이블이 비어있는 심각한 문제를 발견했습니다.
    -   이는 `import_artist_by_mbid` 함수의 마지막에 있는 `db.commit()`이 정상적으로 작동하지 않거나, 보이지 않는 오류로 인해 롤백이 발생하고 있음을 시사합니다.

---

### 내일의 최우선 작업

-   **데이터베이스 커밋 문제 해결:** `services.py`의 `import_artist_by_mbid` 함수 내 `db.commit()` 호출 전후로 상세한 디버깅 로그를 추가하여, 데이터가 왜 DB에 저장되지 않는지에 대한 근본 원인을 파악하고 해결할 것입니다.
