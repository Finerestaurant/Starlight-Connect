# 2026-02-11: MusicBrainz API 디버깅 및 연동 기능 구현 시작

**금일 목표:** MusicBrainz API `404 Not Found` 오류를 해결하고, MusicBrainz 데이터 연동을 위한 첫 번째 기능 구현에 착수한다.

---

## 작업 계획

1.  **MusicBrainz API `404 Not Found` 오류 디버깅:**
    -   `musicbrainzngs` 라이브러리의 버전과 설치 상태를 다시 확인합니다.
    -   `musicbrainzngs.set_useragent()` 설정이 올바른지, API 호출 시 필요한 다른 헤더나 파라미터가 있는지 라이브러리 문서를 다시 확인합니다.
    -   가장 기본적인 형태의 `get_release_by_id` 또는 `search_artist`와 같은 API 호출이 정상적으로 작동하는지 확인하여 문제의 원인(라이브러리 설정, API 호출 방식, MBID 자체의 문제 등)을 파악하고 해결합니다.

2.  **`Person` 모델에 `is_explored` 필드 추가:**
    -   MusicBrainz API 통신이 정상화되면, '연쇄 반응' 데이터 수집 계획에 따라 `backend/app/models.py`의 `Person` 모델에 `is_explored: Mapped[bool]` 필드를 추가하여, 해당 인물의 데이터 탐색 완료 여부를 추적할 수 있도록 합니다. (기존 DB 파일 삭제 후 재생성 필요)

3.  **`services.py`의 MusicBrainz 데이터 파싱 로직 구현 시작:**
    -   `musicbrainz_api.py`를 통해 받아온 MusicBrainz API 응답(Dict[str, Any] 형태)을 우리 시스템의 `schemas.CrawledSongData` 형식으로 변환하는 `_parse_musicbrainz_release_to_schema` 함수를 구현하기 시작합니다.

---

## 진행 상황 및 디버깅 시도 및 코드 구현

-   **MusicBrainz API 연결 오류 해결 및 `requests` 기반 모듈 구현**:
    -   `musicbrainzngs` 라이브러리 사용 시 지속적으로 발생했던 `[Errno 54] Connection reset by peer` 오류가 **`requests` 라이브러리로 직접 API를 호출하여 해결**됨.
    -   `requests` 기반 모듈 구현 시 **재시도 로직과 속도 제한(Rate Limit) 준수를 위한 지연 로직**을 추가함.

-   **백엔드 데이터 수집 파이프라인 구현**:
    -   `musicbrainz_api.py`, `schemas.py`, `crud.py`, `services.py`, `main.py` 등 백엔드의 모든 주요 모듈을 수정하여 MusicBrainz로부터 '연쇄 반응' 방식으로 데이터를 수집, 파싱, 저장하는 전체 파이프라인의 뼈대를 완성함.
    -   탐색할 아티스트 목록을 관리하기 위한 `logs/exploration_queue.json` 파일 및 관련 로직을 구현함.
    -   데이터베이스 모델(`models.py`)에 `mbid`, `is_explored` 등의 필드를 추가하여 확장성을 확보함.

---

## 오늘의 주요 이슈 및 결론

-   **최종 실행 결과**: `start_exploration.sh` 재실행 결과, `processed_artists_count: 0`으로 실제 데이터 수집은 이루어지지 않고 프로세스가 종료됨.
-   **원인 분석**:
    -   `logs/backend.log` 확인 결과, `run_exploration_queue` 함수가 시작될 때 DB에서 '이미 탐색된 아티스트' 목록을 가져옴.
    -   이전의 불완전한 실행으로 인해 DB의 `persons` 테이블에 'Nas' 아티스트의 `is_explored`가 `True`로 이미 설정되어 있었음.
    -   따라서, 초기 시드 아티스트인 'Nas'가 큐에 추가되지 않았고, `while queue:` 루프가 실행되지 않아 프로세스가 즉시 종료된 것으로 보임.
-   **근본적인 문제**: `services.py`의 `_parse_musicbrainz_release_to_schema` 함수의 파싱 로직이 불완전하여, 릴리즈 내의 곡 정보가 DB에 저장되지 않는 문제가 아직 남아있음. 이로 인해 `is_explored` 플래그만 업데이트되는 불완전한 상태가 발생.

---

## 향후 디버깅 포인트

-   **1순위**: **`backend/app/services.py`**의 `_parse_musicbrainz_release_to_schema` 함수가 MusicBrainz API 응답을 올바르게 파싱하여 `CrawledSongData` 객체를 생성하는지 **상세히 검사하고 수정**해야 함. (현재 `release_data.get('release', {})` 부분에 버그가 있을 것으로 추정)
-   **2순위**: **`backend/kpop.db`** 파일을 삭제하여, `is_explored`가 `True`로 잘못 설정된 데이터를 초기화하고 다시 데이터 수집을 시도해야 함.
-   **3순위**: 프론트엔드의 API 호출 로직이 `genius_id` 대신 `mbid`를 사용하도록 수정해야 함.